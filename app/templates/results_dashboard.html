<!-- Page displaying the logged-in user's sentiment analysis history and advanced dashboard. -->
{% extends "base.html" %}

{% block title %}My Dashboard - Sentiment Analyzer{% endblock %}

{% block content %}
<h1 class="mb-4 display-5 cyberpunk-title" data-text="My Analysis Dashboard">My Analysis Dashboard</h1>

{% if results %}
<div class="dashboard-grid">
    <!-- 1. Intents Share (Pie Chart) -->
    <div class="dashboard-card card tilt-card" id="intents-share-card">
        <div class="card-body">
            <h2 class="card-title h5">Intents Share (Top 5)</h2>
            {% if top_5_intents %}
            <canvas id="intentsShareChart"></canvas>
            {% else %}
            <p class="text-muted">Not enough data to display intent distribution.</p>
            {% endif %}
        </div>
    </div>

    <!-- 2. Sentiment Trend Over Time (Line Chart) -->
    <div class="dashboard-card card tilt-card" id="sentiment-trend-card">
        <div class="card-body">
            <h2 class="card-title h5">Sentiment Trend Over Time</h2>
            {% if sentiment_trend_chart_data and sentiment_trend_chart_data.labels %}
            <canvas id="sentimentTrendChart"></canvas>
            {% else %}
            <p class="text-muted">Not enough data to display sentiment trend.</p>
            {% endif %}
        </div>
    </div>

    <!-- 3. Entity Overview (Gauge/Bar) -->
    <div class="dashboard-card card tilt-card" id="entity-overview-card">
        <div class="card-body">
            <h2 class="card-title h5">Overall Sentiment Score</h2>
            <div id="entityOverviewGauge" class="gauge-container">
                <div class="gauge-bar-container">
                    <div id="gaugeBar" class="gauge-bar" style="width: 0%;" data-score="{{ entity_overview_score|round(2) }}"></div>
                </div>
                <div class="gauge-labels">
                    <span>-100%</span>
                    <span>0%</span>
                    <span>+100%</span>
                </div>
                <p id="gaugeValueText" class="text-center mt-2 fw-bold">Score: {{ entity_overview_score|round(2) }}%</p>
            </div>
            <p id="gaugeSummaryText" class="text-center small mt-1">
                <!-- Summary text will be updated by JavaScript -->
            </p>
        </div>
    </div>

    <!-- 4. Related Topics (Word Cloud) -->
    <div class="dashboard-card card tilt-card" id="related-topics-card">
        <div class="card-body">
            <h2 class="card-title h5">Related Topics (Top 20 Keywords)</h2>
            {% if top_20_keywords_data %}
            <div id="relatedTopicsCloud" class="word-cloud-container">
                <!-- Word cloud will be generated by JavaScript -->
            </div>
            {% else %}
            <p class="text-muted">Not enough data to display related topics.</p>
            {% endif %}
        </div>
    </div>
    
    <!-- 5. Filtered Mentions Feed -->
    <div class="dashboard-card card tilt-card" id="filtered-feed-card">
        <div class="card-body">
            <h2 class="card-title h5">Filtered Mentions Feed</h2>
            <!-- Filter Bar -->
            <div id="filter-bar" class="mb-3 p-3 bg-light rounded">
                <h6 class="mb-2">Filter Results:</h6>
                <form id="feed-filter-form" class="row gx-2 gy-2 align-items-center">
                    <div class="col-md-4">
                        <label for="filter-date-range" class="visually-hidden">Date Range</label>
                        <input type="text" id="filter-date-range" class="form-control form-control-sm" placeholder="Date Range (YYYY-MM-DD - YYYY-MM-DD)">
                    </div>
                    <div class="col-md-3">
                        <label for="filter-sentiment" class="visually-hidden">Sentiment</label>
                        <select id="filter-sentiment" class="form-select form-select-sm">
                            <option value="">All Sentiments</option>
                            <option value="Positive">Positive</option>
                            <option value="Neutral">Neutral</option>
                            <option value="Negative">Negative</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filter-intent" class="visually-hidden">Intent</label>
                        <input type="text" id="filter-intent" class="form-control form-control-sm" placeholder="Intent tag">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary btn-sm w-100">Apply</button>
                    </div>
                     <div class="col-md-4">
                        <label for="filter-keyword" class="visually-hidden">Keyword</label>
                        <input type="text" id="filter-keyword" class="form-control form-control-sm" placeholder="Keyword">
                    </div>
                </form>
            </div>

            <div id="mentions-feed" class="list-group feed-items-container">
                {% for result in results %}
                <div class="list-group-item list-group-item-action flex-column align-items-start mb-2 feed-item"
                     data-result-id="{{ result.id }}"
                     data-timestamp="{{ result.timestamp.isoformat() }}"
                     data-sentiment="{{ result.sentiment }}"
                     data-intents='{{ result.intents if result.intents else "[]" }}'
                     data-keywords='{{ result.keywords if result.keywords else "[]" }}'>
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1 feed-item-title">{{ result.original_text|truncate(80, true) }}</h6>
                        <small class="text-muted feed-item-date">{{ result.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                    </div>
                    <p class="mb-1">
                        <span class="badge 
                            {% if result.sentiment == 'Positive' %}bg-success
                            {% elif result.sentiment == 'Negative' %}bg-danger
                            {% else %}bg-secondary
                            {% endif %} feed-item-sentiment-badge">
                            {{ result.sentiment }}
                        </span>
                    </p>
                    <small class="text-muted feed-item-summary">{{ result.original_text|truncate(150) }}</small>
                    <div class="mt-2 feed-item-keywords">
                        {% if result.keywords and result.keywords != '[]' %}
                            {% set keywords_list = result.keywords|from_json %}
                            {% for keyword in keywords_list|slice(5) %} <!-- Show first 5 keywords -->
                                <span class="badge bg-info text-dark me-1 keyword-badge">{{ keyword }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <div id="pagination-controls" class="mt-3 text-center">
                <!-- Pagination will be handled by JavaScript -->
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="card tilt-card p-4 text-center">
    <div class="card-body">
        <h2 class="h4">No Results Yet</h2>
        <p>You haven't analyzed any text yet.</p>
        <a href="{{ url_for('main.analyze') }}" class="btn btn-primary mt-2">Analyze Some Now!</a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }} <!-- Include scripts from the base template -->

<!-- D3.js and d3-cloud for Word Cloud -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/jasondavies/d3-cloud@1.2.7/build/d3.layout.cloud.js"></script>

<!-- flatpickr for date range picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Embed data for charts as JSON -->
<script id="intentsDataJson" type="application/json">
  {{ top_5_intents|tojson|safe if top_5_intents else '{}' }}
</script>
<script id="sentimentTrendDataJson" type="application/json">
  {{ sentiment_trend_chart_data|tojson|safe if sentiment_trend_chart_data and sentiment_trend_chart_data.labels else '{}' }}
</script>
<script id="relatedTopicsDataJson" type="application/json">
  {{ top_20_keywords_data|tojson|safe if top_20_keywords_data else '[]' }}
</script>
<script id="entityOverviewScoreJson" type="application/json">
  {{ entity_overview_score|tojson|safe }}
</script>
<script id="allResultsDataJson" type="application/json">
    {{ results|map(attribute='to_dict' if hasattr(results[0] if results else None, 'to_dict') else (lambda x: {
        'id': x.id,
        'original_text': x.original_text,
        'sentiment': x.sentiment,
        'timestamp': x.timestamp.isoformat(),
        'intents': x.intents|from_json if x.intents else [],
        'keywords': x.keywords|from_json if x.keywords else []
    }))|list|tojson|safe if results else '[]' }}
</script>


<!-- Custom script for dashboard initialization -->
<script>
    // Helper to parse JSON from script tags
    function getJsonData(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            try {
                return JSON.parse(element.textContent);
            } catch (e) {
                console.error(`Error parsing JSON from ${elementId}:`, e);
                return null;
            }
        }
        return null;
    }

document.addEventListener('DOMContentLoaded', function() {
    // Data for charts
    const intentsData = getJsonData('intentsDataJson');
    const sentimentTrendData = getJsonData('sentimentTrendDataJson');
    const relatedTopicsData = getJsonData('relatedTopicsDataJson');
    const entityOverviewScore = getJsonData('entityOverviewScoreJson');
    const allResultsForFeed = getJsonData('allResultsDataJson');

    // 1. Intents Share Chart (Pie)
    if (intentsData && Object.keys(intentsData).length > 0) {
        const ctxIntents = document.getElementById('intentsShareChart').getContext('2d');
        new Chart(ctxIntents, {
            type: 'pie', // or 'doughnut'
            data: {
                labels: Object.keys(intentsData),
                datasets: [{
                    label: 'Intent Share',
                    data: Object.values(intentsData),
                    backgroundColor: [ // Add more colors if expecting more than 5, or generate dynamically
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)'
                    ],
                    borderColor: 'rgba(255, 255, 255, 0.8)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? (context.parsed / total * 100).toFixed(1) : 0;
                                    label += `${context.raw} (${percentage}%)`;
                                }
                                return label;
                            }
                        }
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const chart = elements[0].chart;
                        const activePoint = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true)[0];
                        const intentLabel = chart.data.labels[activePoint.index];
                        filterFeedByIntent(intentLabel);
                    }
                }
            }
        });
    }

    // 2. Sentiment Trend Chart (Line)
    if (sentimentTrendData && sentimentTrendData.labels && sentimentTrendData.labels.length > 0) {
        const ctxTrend = document.getElementById('sentimentTrendChart').getContext('2d');
        new Chart(ctxTrend, {
            type: 'line',
            data: sentimentTrendData, // Expects { labels: [], datasets: [{ label, data, borderColor, fill }, ...] }
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: 'Date' }
                    },
                    y: {
                        title: { display: true, text: 'Number of Mentions' }, // Or 'Average Sentiment Score' if data is structured that way
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                }
                // Add zoom/pan plugin options if desired and library included
            }
        });
    }

    // 3. Entity Overview Gauge
    const gaugeBar = document.getElementById('gaugeBar');
    const gaugeValueText = document.getElementById('gaugeValueText');
    const gaugeSummaryText = document.getElementById('gaugeSummaryText');
    if (gaugeBar && typeof entityOverviewScore === 'number') {
        const score = Math.max(-100, Math.min(100, entityOverviewScore)); // Clamp between -100 and 100
        const percentageWidth = (score + 100) / 2; // Convert -100..+100 to 0..100 for width
        gaugeBar.style.width = percentageWidth + '%';
        
        // Set color based on score
        if (score < -20) gaugeBar.style.backgroundColor = 'var(--bs-danger)';
        else if (score > 20) gaugeBar.style.backgroundColor = 'var(--bs-success)';
        else gaugeBar.style.backgroundColor = 'var(--bs-secondary)';

        gaugeValueText.textContent = `Score: ${score.toFixed(1)}%`;
        
        let summary = "Overall sentiment is ";
        if (score < -50) summary += "very negative.";
        else if (score < -10) summary += "negative.";
        else if (score <= 10) summary += "neutral.";
        else if (score <= 50) summary += "positive.";
        else summary += "very positive.";
        gaugeSummaryText.textContent = summary;
    }


    // 4. Related Topics Word Cloud (using d3-cloud)
    const wordCloudContainer = document.getElementById('relatedTopicsCloud');
    if (relatedTopicsData && relatedTopicsData.length > 0 && wordCloudContainer) {
        const width = wordCloudContainer.offsetWidth || 300;
        const height = 250; // Fixed height or dynamic

        const layout = d3.layout.cloud()
            .size([width, height])
            .words(relatedTopicsData.map(d => ({
                text: d.text, 
                size: 10 + d.weight * 2,  // Adjust scaling factor for size
                avg_sentiment: d.avg_sentiment, // Keep original avg_sentiment for color/tooltip
                color: d.color // Use pre-calculated color
            })))
            .padding(5)
            .rotate(() => (~~(Math.random() * 6) - 3) * 15) // Random rotation -30, -15, 0, 15, 30
            .font("Poppins, sans-serif")
            .fontSize(d => d.size)
            .on("end", drawWordCloud);

        layout.start();

        function drawWordCloud(words) {
            d3.select(wordCloudContainer).append("svg")
                .attr("width", layout.size()[0])
                .attr("height", layout.size()[1])
              .append("g")
                .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
              .selectAll("text")
                .data(words)
              .enter().append("text")
                .style("font-size", d => d.size + "px")
                .style("font-family", "Poppins, sans-serif")
                .style("fill", d => d.color) // Use the color from data
                .attr("text-anchor", "middle")
                .attr("transform", d => "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")")
                .text(d => d.text)
                .on("click", (event, d) => {
                    filterFeedByKeyword(d.text);
                })
                .append("title") // Tooltip on hover
                    .text(d => `${d.text}\nCount: ${((d.size -10) / 2).toFixed(0)}\nAvg. Sentiment Score: ${d.avg_sentiment.toFixed(2)}`);
        }
    } else if (wordCloudContainer) {
        wordCloudContainer.innerHTML = '<p class="text-muted">Not enough keyword data to display word cloud.</p>';
    }

    // 5. Filtered Mentions Feed
    const feedContainer = document.getElementById('mentions-feed');
    const filterForm = document.getElementById('feed-filter-form');
    const paginationControls = document.getElementById('pagination-controls');
    let currentPage = 1;
    const itemsPerPage = 10;

    function renderFeedItems(itemsToRender) {
        feedContainer.innerHTML = ''; // Clear existing items
        if (!itemsToRender || itemsToRender.length === 0) {
            feedContainer.innerHTML = '<p class="text-muted text-center">No results match your filters.</p>';
            return;
        }

        const paginatedItems = itemsToRender.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

        paginatedItems.forEach(result => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'list-group-item list-group-item-action flex-column align-items-start mb-2 feed-item';
            itemDiv.dataset.resultId = result.id;
            itemDiv.dataset.timestamp = result.timestamp;
            itemDiv.dataset.sentiment = result.sentiment;
            itemDiv.dataset.intents = JSON.stringify(result.intents || []);
            itemDiv.dataset.keywords = JSON.stringify(result.keywords || []);

            let sentimentBadgeClass = 'bg-secondary';
            if (result.sentiment === 'Positive') sentimentBadgeClass = 'bg-success';
            else if (result.sentiment === 'Negative') sentimentBadgeClass = 'bg-danger';

            let keywordsHTML = '';
            if (result.keywords && result.keywords.length > 0) {
                keywordsHTML = result.keywords.slice(0, 5).map(kw => `<span class="badge bg-info text-dark me-1 keyword-badge">${kw}</span>`).join('');
            }
            
            const dateFormatted = new Date(result.timestamp).toLocaleString('default', { year: 'numeric', month: 'short', day: 'numeric', hour:'2-digit', minute:'2-digit' });

            itemDiv.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1 feed-item-title">${result.original_text.substring(0,80)}${result.original_text.length > 80 ? '...' : ''}</h6>
                    <small class="text-muted feed-item-date">${dateFormatted}</small>
                </div>
                <p class="mb-1">
                    <span class="badge ${sentimentBadgeClass} feed-item-sentiment-badge">${result.sentiment}</span>
                </p>
                <small class="text-muted feed-item-summary">${result.original_text.substring(0,150)}${result.original_text.length > 150 ? '...' : ''}</small>
                <div class="mt-2 feed-item-keywords">${keywordsHTML}</div>
            `;
            // Add click listener for drill-down (optional)
            itemDiv.addEventListener('click', () => console.log('Clicked item:', result.id));
            feedContainer.appendChild(itemDiv);
        });
        renderPagination(itemsToRender.length);
    }

    function renderPagination(totalItems) {
        paginationControls.innerHTML = '';
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (totalPages <= 1) return;

        const prevButton = document.createElement('button');
        prevButton.className = 'btn btn-sm btn-outline-secondary me-1';
        prevButton.textContent = 'Previous';
        prevButton.disabled = currentPage === 1;
        prevButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                applyFilters();
            }
        });
        paginationControls.appendChild(prevButton);

        // Page numbers (simplified)
        const pageInfo = document.createElement('span');
        pageInfo.className = 'align-middle mx-2';
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        paginationControls.appendChild(pageInfo);

        const nextButton = document.createElement('button');
        nextButton.className = 'btn btn-sm btn-outline-secondary ms-1';
        nextButton.textContent = 'Next';
        nextButton.disabled = currentPage === totalPages;
        nextButton.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                applyFilters();
            }
        });
        paginationControls.appendChild(nextButton);
    }
    
    function applyFilters() {
        const dateRangeVal = document.getElementById('filter-date-range')._flatpickr.selectedDates;
        const sentimentVal = document.getElementById('filter-sentiment').value.toLowerCase();
        const intentVal = document.getElementById('filter-intent').value.toLowerCase();
        const keywordVal = document.getElementById('filter-keyword').value.toLowerCase();

        let filteredResults = allResultsForFeed.filter(item => {
            let match = true;
            // Date filter
            if (dateRangeVal.length === 2) {
                const itemDate = new Date(item.timestamp);
                // Normalize dates to avoid time issues if not needed
                const startDate = new Date(dateRangeVal[0]);
                startDate.setHours(0,0,0,0);
                const endDate = new Date(dateRangeVal[1]);
                endDate.setHours(23,59,59,999);
                if (itemDate < startDate || itemDate > endDate) {
                    match = false;
                }
            }
            // Sentiment filter
            if (match && sentimentVal && item.sentiment.toLowerCase() !== sentimentVal) {
                match = false;
            }
            // Intent filter
            if (match && intentVal) {
                const itemIntents = (item.intents || []).map(i => i.toLowerCase());
                if (!itemIntents.some(i => i.includes(intentVal))) {
                    match = false;
                }
            }
            // Keyword filter
            if (match && keywordVal) {
                const itemKeywords = (item.keywords || []).map(k => k.toLowerCase());
                 if (!itemKeywords.some(k => k.includes(keywordVal)) && !item.original_text.toLowerCase().includes(keywordVal)) { // also check in text
                    match = false;
                }
            }
            return match;
        });
        renderFeedItems(filteredResults);
    }

    filterForm.addEventListener('submit', (e) => {
        e.preventDefault();
        currentPage = 1; // Reset to first page on new filter
        applyFilters();
    });

    // Initialize flatpickr for date range
    flatpickr("#filter-date-range", {
        mode: "range",
        dateFormat: "Y-m-d",
        onChange: function(selectedDates, dateStr, instance) {
            // Optionally auto-apply filter on date change, or wait for submit
            // applyFilters(); 
        }
    });
    
    // Initial render of the feed
    if (allResultsForFeed) {
        renderFeedItems(allResultsForFeed);
    }

    // Functions to update feed based on chart clicks
    window.filterFeedByIntent = function(intent) {
        document.getElementById('filter-intent').value = intent;
        document.getElementById('filter-sentiment').value = ''; // Clear other filters
        document.getElementById('filter-keyword').value = '';
        if (document.getElementById('filter-date-range')._flatpickr) {
            document.getElementById('filter-date-range')._flatpickr.clear();
        }
        currentPage = 1;
        applyFilters();
        document.getElementById('filtered-feed-card').scrollIntoView({ behavior: 'smooth' });
    }

    window.filterFeedByKeyword = function(keyword) {
        document.getElementById('filter-keyword').value = keyword;
        document.getElementById('filter-sentiment').value = '';
        document.getElementById('filter-intent').value = '';
         if (document.getElementById('filter-date-range')._flatpickr) {
            document.getElementById('filter-date-range')._flatpickr.clear();
        }
        currentPage = 1;
        applyFilters();
        document.getElementById('filtered-feed-card').scrollIntoView({ behavior: 'smooth' });
    }
    
    // Initialize 3D Tilt Effects for the new cards
    if (typeof VanillaTilt !== 'undefined') {
        VanillaTilt.init(document.querySelectorAll(".dashboard-card.tilt-card"), {
            max: 10,       // Max tilt rotation (degrees)
            speed: 400,    // Speed of the enter/exit transition
            glare: true,   // If it should have a "glare" effect
            "max-glare": 0.2 // From 0 - 1
        });
    }

});
</script>
{% endblock %}
