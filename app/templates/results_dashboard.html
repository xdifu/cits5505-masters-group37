<!-- Page displaying the logged-in user's sentiment analysis history and advanced dashboard. -->
{% extends "base.html" %}

{% block title %}Dashboard: {{ report.name if report else 'My Analysis' }} - Sentiment Analyzer{% endblock %}

{% block content %}
<h1 class="mb-4 display-5 cyberpunk-title" data-text="{{ report.name if report else 'My Analysis Dashboard' }}">{{ report.name if report else 'My Analysis Dashboard' }}</h1>

{% if results_exist %} {# This variable should be passed from the Flask route #}
<div class="dashboard-grid">
    <!-- 1. Intents Share (Top 5) -->
    <div class="dashboard-card card tilt-card" id="intents-share-card">
        <div class="card-body">
            <h2 class="card-title h5">Main Intent Tags</h2>
            <p class="text-muted small">Most common intent tags in the analyzed content</p>
            {% if top_5_intents %}
                <div class="intents-list mt-3 d-flex flex-wrap gap-2">
                    {% for intent, _ in top_5_intents.items() %}
                    <span class="badge bg-secondary">{{ intent }}</span>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">Not enough data to display intent distribution.</p>
            {% endif %}
        </div>
    </div>

    <!-- 2. Sentiment Trend Over Time (Line Chart) -->
    <div class="dashboard-card card tilt-card" id="sentiment-trend-card">
        <div class="card-body">
            <h2 class="card-title h5">Sentiment Trend Over Time</h2>
            {% if sentiment_trend_chart_data and sentiment_trend_chart_data.labels %}
            <canvas id="sentimentTrendChart"></canvas>
            {% else %}
            <p class="text-muted">Not enough data to display sentiment trend.</p>
            {% endif %}
        </div>
    </div>

    <!-- 3. Sentiment Overview (simplified, replaces “Entity Overview”) -->
    <div class="dashboard-card card tilt-card" id="sentiment-overview-card">
      <div class="card-body text-center">
        <h2 class="card-title h5">Sentiment Overview</h2>
        <p class="text-muted small">Overall sentiment score for this report</p>

        <!-- only show the percentage & label -->
        <div class="mt-3">
          <p id="gaugeAverageSentimentText" class="display-5 fw-bold mb-1"></p>
          <p id="gaugeCoverageText"      class="h6 text-capitalize"></p>
        </div>
      </div>
    </div>

    <!-- 4. Related Topics (Word Cloud) -->
    <div class="dashboard-card card tilt-card" id="related-topics-card">
        <div class="card-body">
            <h2 class="card-title h5">Related Topics (Top 20 Keywords)</h2>
            {% if top_20_keywords_data %}
            <div id="relatedTopicsCloud" class="word-cloud-container">
                <!-- Word cloud will be generated by JavaScript -->
            </div>
            {% else %}
            <p class="text-muted">Not enough data to display related topics.</p>
            {% endif %}
        </div>
    </div>
    
    <!-- 5. Filtered Mentions Feed -->
    <div class="dashboard-card card tilt-card" id="filtered-feed-card">
        <div class="card-body">
            <h2 class="card-title h5">Filtered Mentions Feed</h2>
            <!-- Filter Bar -->
            <div id="filter-bar" class="mb-3 p-3 bg-light rounded">
                <h6 class="mb-2">Filter Results:</h6>
                <form id="feed-filter-form" class="row gx-2 gy-2 align-items-end">
                    <div class="col-md-6 col-lg-4">
                        <label for="filter-date-range" class="form-label form-label-sm">Date Range</label>
                        <input type="text" id="filter-date-range" class="form-control form-control-sm" placeholder="YYYY-MM-DD to YYYY-MM-DD">
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <label for="filter-keyword" class="form-label form-label-sm">Keyword</label>
                        <input type="text" id="filter-keyword" class="form-control form-control-sm" placeholder="Enter keyword">
                    </div>
                    <div class="col-md-4 col-lg-2">
                        <label for="filter-sentiment-min" class="form-label form-label-sm">Min Score</label>
                        <input type="number" id="filter-sentiment-min" class="form-control form-control-sm" placeholder="-1.0" min="-1" max="1" step="0.01">
                    </div>
                    <div class="col-md-4 col-lg-2">
                        <label for="filter-sentiment-max" class="form-label form-label-sm">Max Score</label>
                        <input type="number" id="filter-sentiment-max" class="form-control form-control-sm" placeholder="1.0" min="-1" max="1" step="0.01">
                    </div>
                    <div class="col-md-4 col-lg-3">
                        <label for="filter-intent" class="form-label form-label-sm">Intent</label>
                        <input type="text" id="filter-intent" class="form-control form-control-sm" placeholder="Intent tag">
                    </div>
                    <div class="col-md-12 col-lg-1"> {# Changed to col-lg-1 for button to be small on large screens #}
                        <button type="submit" class="btn btn-primary btn-sm w-100 mt-3 mt-lg-0">Apply</button>
                    </div>
                </form>
            </div>

            <div id="mentions-feed" class="list-group feed-items-container">
                {% for result in results %} {# Assuming results are news_items_for_feed #}
                <div class="list-group-item list-group-item-action flex-column align-items-start mb-2 feed-item"
                     data-result-id="{{ result.id }}"
                     data-timestamp="{{ result.timestamp.isoformat() }}"
                     data-sentiment="{{ result.sentiment }}" 
                     data-sentiment-score="{{ result.sentiment_score|round(2) if result.sentiment_score is not none else '' }}"
                     data-intents='{{ result.intents|tojson|safe if result.intents else "[]" }}'
                     data-keywords='{{ result.keywords|tojson|safe if result.keywords else "[]" }}'>
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1 feed-item-title">{{ result.original_text|truncate(80, true) }}</h6>
                        <small class="text-muted feed-item-date">{{ result.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                    </div>
                    <p class="mb-1">
                        <span class="badge 
                            {% if result.sentiment_score is not none and result.sentiment_score > 0.1 %}bg-success
                            {% elif result.sentiment_score is not none and result.sentiment_score < -0.1 %}bg-danger
                            {% else %}bg-secondary
                            {% endif %} feed-item-sentiment-badge">
                            {{ result.sentiment }}
                            {% if result.sentiment_score is not none %}
                                ({{ (result.sentiment_score * 100)|round(0) }}%)
                            {% endif %}
                        </span>
                    </p>
                    <small class="mb-1 text-muted feed-item-summary">{{ result.original_text|truncate(150) }}</small>
                    
                    <!-- Add Intent Tags Display -->
                    <div class="mb-2 mt-2 feed-item-intents">
                        {% if result.intents %}
                            {% set intents_list = result.intents|from_json if result.intents is string else result.intents %}
                            {% if intents_list and intents_list|length > 0 %}
                                <small class="text-muted me-2">Intents:</small>
                                {% for intent in intents_list %}
                                    <span class="badge bg-secondary me-1 intent-badge">{{ intent }}</span>
                                {% endfor %}
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    <div class="mt-2 feed-item-keywords">
                        {% if result.keywords %}
                            {% set keywords_list = result.keywords|from_json if result.keywords is string else result.keywords %}
                            {% if keywords_list and keywords_list|length > 0 %}
                                <small class="text-muted me-2">Keywords:</small>
                                {% for keyword in keywords_list|slice(5) %}
                                    <span class="badge bg-info text-dark me-1 keyword-badge">{{ keyword }}</span>
                                {% endfor %}
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <div id="pagination-controls" class="mt-3 text-center">
                <!-- Pagination will be handled by JavaScript -->
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="card tilt-card p-4 text-center">
    <div class="card-body">
        <h2 class="h4">No Results Yet</h2>
        <p>You haven't analyzed any text yet or there are no results for this report.</p>
        <a href="{{ url_for('main.analyze') }}" class="btn btn-primary mt-2">Analyze Some Now!</a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }} <!-- Include scripts from the base template -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-cloud@1.2.5/build/d3.layout.cloud.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{# External JS files for charts and feed filter are commented out as per original attachment, #}
{# assuming the logic is now primarily within this file's script block. #}
{# <script src="{{ url_for('static', filename='js/results_dashboard_charts.js') }}"></script> #}
<script src="{{ url_for('static', filename='js/mentions_feed_filter.js') }}"></script>

<script>
    // Removed the flaskData object and redundant global variables.
    // Data will be sourced using getJsonData from individual script tags below.
</script>

<!-- Embed data for charts as JSON -->
<script id="intentsDataJson" type="application/json">
  {{ top_5_intents|tojson|safe if top_5_intents else '{}' }}
</script>
<script id="sentimentTrendDataJson" type="application/json">
  {{ sentiment_trend_chart_data|tojson|safe if sentiment_trend_chart_data and sentiment_trend_chart_data.labels else '{}' }}
</script>
<script id="relatedTopicsDataJson" type="application/json">
  {{ top_20_keywords_data|tojson|safe if top_20_keywords_data else '[]' }}
</script>
<script id="entityOverviewScoreJson" type="application/json">
  {{ entity_overview_score|tojson|safe }}
</script>
<script id="allResultsDataJson" type="application/json">
    {# news_items_for_feed is now a list of dicts passed from the route #}
    {{ news_items_for_feed | tojson | safe if news_items_for_feed else '[]' }}
</script>


<!-- Custom script for dashboard initialization -->
<script>
    // Helper to parse JSON from script tags
    function getJsonData(elementId) {
        const element = document.getElementById(elementId);
        if (element && element.textContent.trim()) {
            try {
                return JSON.parse(element.textContent);
            } catch (e) {
                console.error(`Error parsing JSON from ${elementId}:`, e, "Content:", element.textContent);
                return null; // Return null on parsing error
            }
        }
        return null; // Return null if element or content is missing
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Data for charts and gauge
        const intentsData = getJsonData('intentsDataJson');
        const sentimentTrendData = getJsonData('sentimentTrendDataJson');
        const relatedTopicsData = getJsonData('relatedTopicsDataJson');
        const entityOverviewScoreRaw = getJsonData('entityOverviewScoreJson'); // Directly use getJsonData
        const allResultsForFeed = getJsonData('allResultsDataJson');
        // const reportId = getJsonData('reportIdJson'); // Assuming reportId might also be passed this way if needed

        // console.log("Entity Overview Score Raw:", entityOverviewScoreRaw); // For debugging

        // 1. Intents Share Chart (Doughnut)
        // if (intentsData && Object.keys(intentsData).length > 0) {
        //     const ctxIntents = document.getElementById('intentsShareChart').getContext('2d');
            
        //     // Neutral color palette for the doughnut chart
        //     const intentColors = [
        //         'rgba(108, 117, 125, 0.7)',  // gray
        //         'rgba(100, 130, 160, 0.7)',  // blue-gray
        //         'rgba(130, 110, 165, 0.7)',  // purple-gray
        //         'rgba(160, 120, 95, 0.7)',   // brown-gray 
        //         'rgba(110, 140, 120, 0.7)'   // green-gray
        //     ];
            
        //     // Calculate total for percentage
        //     const total = Object.values(intentsData).reduce((sum, val) => sum + val, 0);
            
        //     new Chart(ctxIntents, {
        //         type: 'doughnut',
        //         data: {
        //             labels: Object.keys(intentsData),
        //             datasets: [{
        //                 label: 'Intent Share',
        //                 data: Object.values(intentsData),
        //                 backgroundColor: intentColors,
        //                 borderColor: 'rgba(255, 255, 255, 0.8)',
        //                 borderWidth: 1
        //             }]
        //         },
        //         options: {
        //             responsive: true, 
        //             maintainAspectRatio: false,
        //             cutout: '60%',  // Doughnut hole size
        //             plugins: {
        //                 legend: { 
        //                     position: 'right',
        //                     labels: {
        //                         generateLabels: function(chart) {
        //                             // Custom labels showing count and percentage
        //                             const data = chart.data;
        //                             if (data.labels.length && data.datasets.length) {
        //                                 return data.labels.map(function(label, i) {
        //                                     const value = data.datasets[0].data[i];
        //                                     const percentage = ((value / total) * 100).toFixed(1);
        //                                     return {
        //                                         text: `${label}: ${value} (${percentage}%)`,
        //                                         fillStyle: intentColors[i],
        //                                         strokeStyle: intentColors[i],
        //                                         lineWidth: 0,
        //                                         hidden: false,
        //                                         index: i
        //                                     };
        //                                 });
        //                             }
        //                             return [];
        //                         }
        //                     },
        //                     tooltip: {
        //                         callbacks: {
        //                             label: function(context) {
        //                                 const value = context.parsed;
        //                                 const percentage = ((value / total) * 100).toFixed(1);
        //                                 return `${context.label}: ${value} occurrences (${percentage}%)`;
        //                             }
        //                         }
        //                     }
        //                 },
        //                 onClick: (event, elements) => {
        //                     if (elements.length > 0) {
        //                         const chart = elements[0].chart;
        //                         const activePoint = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true)[0];
        //                         if (activePoint) {
        //                             const intentLabel = chart.data.labels[activePoint.index];
        //                             filterFeedByIntent(intentLabel);
        //                         }
        //                     }
        //                 }
        //             }
        //         });
        // }

        // 2. Sentiment Trend Chart (Line)
        // Y-axis title and scale (-1 to 1) are set here.
        if (sentimentTrendData && sentimentTrendData.labels && sentimentTrendData.labels.length > 0 && sentimentTrendData.datasets) {
            const ctxTrend = document.getElementById('sentimentTrendChart').getContext('2d');
            new Chart(ctxTrend, {
                type: 'line',
                data: sentimentTrendData, // Expects { labels: [], datasets: [{ label, data, borderColor, fill }, ...] }
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Date' } },
                        y: { title: { display: true, text: 'Average Sentiment Score' }, min: -1, max: 1 }
                    },
                    plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } }
                }
            });
        }

        // 3. Sentiment Overview Gauge (Custom HTML/CSS Version)
        const customGaugePointer = document.getElementById('customGaugePointer');
        const gaugeAverageSentimentText = document.getElementById('gaugeAverageSentimentText');
        const gaugeCoverageText = document.getElementById('gaugeCoverageText');

        if (customGaugePointer && gaugeAverageSentimentText && gaugeCoverageText) {
            if (typeof entityOverviewScoreRaw === 'number' && !isNaN(entityOverviewScoreRaw)) {
                // Clamp score to the valid range of -1.0 to +1.0
                const score = Math.max(-1, Math.min(1, entityOverviewScoreRaw));

                // Convert score from -1 to 1 range to 0% to 100% for pointer positioning
                // Example: score -1 -> 0%; score 0 -> 50%; score 1 -> 100%
                const pointerPositionPercent = ((score + 1) / 2) * 100;
                customGaugePointer.style.left = `${pointerPositionPercent}%`;

                // Display average sentiment score as percentage, e.g., "+32%", "-50%", "+0%"
                const scoreAsPercentage = (score * 100).toFixed(0);
                gaugeAverageSentimentText.textContent = `Average Sentiment: ${scoreAsPercentage >= 0 ? '+' : ''}${scoreAsPercentage}%`;

                // Determine and display summary coverage text
                let coverageSummary = "Mainly ";
                if (score > 0.15) { // Threshold for being distinctly positive
                    coverageSummary += "positive";
                } else if (score < -0.15) { // Threshold for being distinctly negative
                    coverageSummary += "negative";
                } else {
                    coverageSummary += "neutral";
                }
                coverageSummary += " coverage.";
                gaugeCoverageText.textContent = coverageSummary;

            } else {
                // Handle case where score is not available or not a valid number
                customGaugePointer.style.left = '50%'; // Default to neutral (0%) position
                gaugeAverageSentimentText.textContent = 'Average Sentiment: N/A';
                gaugeCoverageText.textContent = 'Overall sentiment data not available.';
                // console.warn("Entity Overview Score is not a valid number:", entityOverviewScoreRaw); // For debugging
            }
        } else {
            // console.error("One or more gauge elements not found in the DOM."); // For debugging
        }

        // 4. Related Topics Word Cloud (using d3-cloud)
        const wordCloudContainer = document.getElementById('relatedTopicsCloud');
        if (relatedTopicsData && relatedTopicsData.length > 0 && wordCloudContainer) {
            const width = wordCloudContainer.offsetWidth || 300;
            const height = 250; 

            function drawWordCloud(words) {
                d3.select(wordCloudContainer).html(''); // Clear previous if any
                d3.select(wordCloudContainer).append("svg")
                    .attr("width", layout.size()[0]).attr("height", layout.size()[1])
                  .append("g")
                    .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
                  .selectAll("text")
                    .data(words)
                  .enter().append("text")
                    .style("font-size", d => d.size + "px").style("font-family", "Poppins, sans-serif")
                    .style("fill", d => d.color) // Color from data (pre-calculated in Python)
                    .attr("text-anchor", "middle")
                    .attr("transform", d => "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")")
                    .text(d => d.text)
                    .on("click", (event, d) => { filterFeedByKeyword(d.text); })
                    .append("title") // Tooltip on hover
                        .text(d => `${d.text}\nCount: ${((d.size -10) / 2).toFixed(0)}\nAvg. Sentiment Score: ${d.avg_sentiment !== undefined && d.avg_sentiment !== null ? d.avg_sentiment.toFixed(2) : 'N/A'}`); // JavaScript Template literal
            }
            
            const layout = d3.layout.cloud()
                .size([width, height])
                .words(relatedTopicsData.map(d => ({
                    text: d.text, 
                    size: 10 + d.weight * 2,  // Adjust scaling factor for size
                    avg_sentiment: d.avg_sentiment, 
                    color: d.color // Use pre-calculated color from data
                })))
                .padding(5).rotate(() => (Math.random() * 6 - 3) * 15)
                .font("Poppins, sans-serif").fontSize(d => d.size)
                .on("end", drawWordCloud);
            layout.start();
        } else if (wordCloudContainer) {
            wordCloudContainer.innerHTML = '<p class="text-muted">Not enough keyword data to display word cloud.</p>';
        }

        // 5. Filtered Mentions Feed
        const feedContainer = document.getElementById('mentions-feed');
        const filterForm = document.getElementById('feed-filter-form');
        const paginationControls = document.getElementById('pagination-controls');
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentFilteredResults = []; // Stores the currently filtered (but not paginated) results

        function renderFeedItems(itemsToRender) {
            feedContainer.innerHTML = ''; 
            if (!itemsToRender || itemsToRender.length === 0) {
                feedContainer.innerHTML = '<p class="text-muted text-center">No results match your filters.</p>';
                renderPagination(0); // Clear or hide pagination
                return;
            }

            const paginatedItems = itemsToRender.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            paginatedItems.forEach(result => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'list-group-item list-group-item-action flex-column align-items-start mb-2 feed-item';
                itemDiv.dataset.resultId = result.id;
                itemDiv.dataset.timestamp = result.timestamp; // Assuming result.timestamp is an ISO string or serializable
                itemDiv.dataset.sentiment = result.sentiment; // String: "Positive", "Neutral", "Negative"
                itemDiv.dataset.sentimentScore = (typeof result.sentiment_score === 'number') ? result.sentiment_score.toFixed(2) : '';
                itemDiv.dataset.intents = JSON.stringify(result.intents || []);
                itemDiv.dataset.keywords = JSON.stringify(result.keywords || []);

                let sentimentBadgeClass = 'bg-secondary';
                let sentimentScorePercentText = '';

                if (typeof result.sentiment_score === 'number') {
                    sentimentScorePercentText = `(${(result.sentiment_score * 100).toFixed(0)}%)`;
                    if (result.sentiment_score > 0.1) sentimentBadgeClass = 'bg-success';
                    else if (result.sentiment_score < -0.1) sentimentBadgeClass = 'bg-danger';
                } else if (result.sentiment) { // Fallback to sentiment string if score not available for class
                     if (result.sentiment === 'Positive') sentimentBadgeClass = 'bg-success';
                     else if (result.sentiment === 'Negative') sentimentBadgeClass = 'bg-danger';
                }
                
                let keywordsHTML = '';
                if (result.keywords && Array.isArray(result.keywords) && result.keywords.length > 0) {
                    keywordsHTML = result.keywords.slice(0, 5).map(kw => `<span class="badge bg-info text-dark me-1 keyword-badge">${kw}</span>`).join('');
                }
                
                const dateFormatted = new Date(result.timestamp).toLocaleString('default', { year: 'numeric', month: 'short', day: 'numeric', hour:'2-digit', minute:'2-digit' });

                itemDiv.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1 feed-item-title">${(result.original_text || "").substring(0,80)}${(result.original_text || "").length > 80 ? '...' : ''}</h6>
                        <small class="text-muted feed-item-date">${dateFormatted}</small>
                    </div>
                    <p class="mb-1">
                        <span class="badge ${sentimentBadgeClass} feed-item-sentiment-badge">${result.sentiment || 'N/A'} ${sentimentScorePercentText}</span>
                    </p>
                    <small class="text-muted feed-item-summary">${(result.original_text || "").substring(0,150)}${(result.original_text || "").length > 150 ? '...' : ''}</small>
                    <div class="mt-2 feed-item-keywords">${keywordsHTML}</div>
                `; // JavaScript Template literal
                itemDiv.addEventListener('click', () => { /* Placeholder for drill-down modal */ console.log('Clicked item:', result.id); });
                feedContainer.appendChild(itemDiv);
            });
            renderPagination(itemsToRender.length);
        }

        function renderPagination(totalItems) {
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.className = 'btn btn-sm btn-outline-secondary me-1';
            prevButton.textContent = 'Previous';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) { currentPage--; renderFeedItems(currentFilteredResults); }
            });
            paginationControls.appendChild(prevButton);

            const pageInfo = document.createElement('span');
            pageInfo.className = 'align-middle mx-2';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`; // JavaScript Template literal
            paginationControls.appendChild(pageInfo);

            const nextButton = document.createElement('button');
            nextButton.className = 'btn btn-sm btn-outline-secondary ms-1';
            nextButton.textContent = 'Next';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) { currentPage++; renderFeedItems(currentFilteredResults); }
            });
            paginationControls.appendChild(nextButton);
        }
        
        function applyFilters() {
            const dateRangeVal = document.getElementById('filter-date-range')._flatpickr.selectedDates;
            const sentimentMinValStr = document.getElementById('filter-sentiment-min').value;
            const sentimentMaxValStr = document.getElementById('filter-sentiment-max').value;
            const intentVal = document.getElementById('filter-intent').value.toLowerCase();
            const keywordVal = document.getElementById('filter-keyword').value.toLowerCase();

            const sentimentMin = sentimentMinValStr !== "" ? parseFloat(sentimentMinValStr) : null;
            const sentimentMax = sentimentMaxValStr !== "" ? parseFloat(sentimentMaxValStr) : null;
            
            const sourceFeedItems = getJsonData('allResultsDataJson') || [];


            let filteredResults = sourceFeedItems.filter(item => {
                let match = true;
                // Date filter
                if (dateRangeVal && dateRangeVal.length === 2) {
                    const itemDate = new Date(item.timestamp);
                    const startDate = new Date(dateRangeVal[0]);
                    startDate.setHours(0,0,0,0);
                    const endDate = new Date(dateRangeVal[1]);
                    endDate.setHours(23,59,59,999);
                    if (itemDate < startDate || itemDate > endDate) {
                        match = false;
                    }
                }

                // Sentiment Score filter
                const itemSentimentScore = typeof item.sentiment_score === 'number' ? item.sentiment_score : null;

                if (match && itemSentimentScore !== null) {
                    if (sentimentMin !== null && itemSentimentScore < sentimentMin) {
                        match = false;
                    }
                    if (match && sentimentMax !== null && itemSentimentScore > sentimentMax) {
                        match = false;
                    }
                } else if (match && (sentimentMin !== null || sentimentMax !== null)) { 
                    // If filtering by score, but item has no score (or score is not a number), it doesn't match.
                    match = false;
                }
                
                // Intent filter
                if (match && intentVal) {
                    const itemIntents = (Array.isArray(item.intents) ? item.intents : []).map(i => String(i).toLowerCase());
                    if (!itemIntents.some(i => i.includes(intentVal))) {
                        match = false;
                    }
                }
                // Keyword filter
                if (match && keywordVal) {
                    const itemKeywords = (Array.isArray(item.keywords) ? item.keywords : []).map(k => String(k).toLowerCase());
                     if (!itemKeywords.some(k => k.includes(keywordVal)) && !(item.original_text || "").toLowerCase().includes(keywordVal)) {
                        match = false;
                    }
                }
                return match;
            });
            renderFeedItems(filteredResults);
        }

        filterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            applyFilters();
        });

        // Initialize flatpickr for date range
        const dateRangePickerElement = document.getElementById('filter-date-range');
        if (dateRangePickerElement) {
            flatpickr(dateRangePickerElement, {
                mode: "range",
                dateFormat: "Y-m-d",
                // Optionally auto-apply filter on date change:
                // onChange: function(selectedDates, dateStr, instance) { applyFilters(); } 
            });
        }
        
        // Initial render of the feed with all items passed from Flask
        if (allResultsForFeed && allResultsForFeed.length > 0) {
            currentFilteredResults = [...allResultsForFeed]; 
            renderFeedItems(currentFilteredResults);
        } else {
            renderFeedItems([]); // Render empty state if no initial items
        }

        // Functions to update feed based on chart clicks
        window.filterFeedByIntent = function(intent) {
            document.getElementById('filter-intent').value = intent;
            document.getElementById('filter-sentiment-min').value = ''; 
            document.getElementById('filter-sentiment-max').value = ''; 
            document.getElementById('filter-keyword').value = '';
            if (document.getElementById('filter-date-range')._flatpickr) {
                document.getElementById('filter-date-range')._flatpickr.clear();
            }
            
            applyFilters(); // Apply the intent filter and reset others
            const feedCard = document.getElementById('filtered-feed-card');
            if(feedCard) { feedCard.scrollIntoView({ behavior: 'smooth' }); }
        }

        window.filterFeedByKeyword = function(keyword) {
            document.getElementById('filter-keyword').value = keyword;
            document.getElementById('filter-sentiment-min').value = ''; 
            document.getElementById('filter-sentiment-max').value = ''; 
            document.getElementById('filter-intent').value = '';
             if (document.getElementById('filter-date-range')._flatpickr) {
                document.getElementById('filter-date-range')._flatpickr.clear();
            }

            applyFilters(); // Apply the keyword filter and reset others
            const feedCard = document.getElementById('filtered-feed-card');
            if(feedCard) { feedCard.scrollIntoView({ behavior: 'smooth' }); }
        }
        
        // Initialize 3D Tilt Effects for the dashboard cards
        if (typeof VanillaTilt !== 'undefined') {
            document.querySelectorAll(".dashboard-card.tilt-card").forEach(el => {
                // Only initialize on elements narrower than a certain threshold (e.g., 600px)
                // or if you want to disable it for all dashboard cards, you can adjust this condition
                if (el.offsetWidth < 600) { // You can adjust this width or remove the condition if tilt is desired but less intense
                    VanillaTilt.init(el, {
                        max: 5, // Reduced max tilt for dashboard cards
                        speed: 400, 
                        glare: true, 
                        "max-glare": 0.1 // Reduced glare for a subtler effect
                    });
                }
            });
        } else {
            // console.warn("VanillaTilt library not found. Tilt effect disabled.");
        }

        // New simplified sentiment overview display logic
        const scoreRaw = getJsonData('entityOverviewScoreJson');
        const avgEl   = document.getElementById('gaugeAverageSentimentText');
        const lblEl   = document.getElementById('gaugeCoverageText');

        if (typeof scoreRaw === 'number' && !isNaN(scoreRaw)) {
          // clamp and convert to percentage
          const clamped = Math.max(-1, Math.min(1, scoreRaw));
          const pct     = Math.round(clamped * 100);
          const sign    = pct > 0 ? '+' : '';
          avgEl.textContent = `${sign}${pct}%`;               // e.g. “-70%” or “+30%”

          // choose a simple label
          const label = pct > 0 ? 'Positive'
                      : pct < 0 ? 'Negative'
                      : 'Neutral';
          lblEl.textContent = label;                          // e.g. “Negative”
        } else {
          avgEl.textContent = 'N/A';
          lblEl.textContent = 'Neutral';
        }
    });
</script>
{% endblock %}
