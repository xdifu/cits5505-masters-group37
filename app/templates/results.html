<!-- Page displaying the logged-in user's sentiment analysis history and chart. -->
<!-- Extends the base layout and shows results with share options. -->
{% extends "base.html" %}

{% block title %}My Analysis Results - Sentiment Analyzer{% endblock %}

{% block content %}
<h1 class="mb-4 display-5 cyberpunk-title" data-text="My Analysis Results">My Analysis Results</h1>

{% if results %}
<div class="row">
    <div class="col-lg-8">
        <div class="list-group tilt-card">
            {% for report_item in results %} <!-- Iterate over AnalysisReport objects -->
            <div class="list-group-item list-group-item-action flex-column align-items-start mb-3">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">
                        <!-- Display Report Name and link to its dashboard -->
                        <a href="{{ url_for('main.results_dashboard', report_id=report_item.id) }}">{{ report_item.name }}</a>
                    </h5>
                    <small class="text-muted">Created on: {{ report_item.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                </div>
                <p class="mb-1">
                    <strong>Overall Sentiment Score:</strong> 
                    {% if report_item.overall_sentiment_score is not none %}
                        {{ "%.2f" | format(report_item.overall_sentiment_score) }}
                        {% set score = report_item.overall_sentiment_score %}
                        {% if score > 0.1 %}
                            <span class="badge bg-success ms-1">Positive</span>
                        {% elif score < -0.1 %}
                            <span class="badge bg-danger ms-1">Negative</span>
                        {% else %}
                            <span class="badge bg-secondary ms-1">Neutral</span>
                        {% endif %}
                    {% else %}
                        <span class="text-muted ms-1">N/A</span>
                    {% endif %}
                </p>
                
                {% if report_item.item_count > 0 %}
                  <p class="mb-1 mt-2">
                    <small class="text-muted">
                      Contains {{ report_item.item_count }} news item{{ 's' if report_item.item_count > 1 else '' }}.
                    </small>
                  </p>
                {% else %}
                  <p class="mb-1 mt-2">
                    <small class="text-muted">No individual items in this report.</small>
                  </p>
                {% endif %}
                
                <div class="mt-3 share-buttons">
                  <!-- Share button: use main.share_report and report_id -->
                  <a href="{{ url_for('main.share_report', report_id=report_item.id) }}"
                     class="btn btn-sm btn-outline-primary share-btn me-2">
                    Share
                  </a>

                  <!-- Manage sharing: use main.manage_report_sharing and report_id -->
                  <a href="{{ url_for('main.manage_report_sharing', report_id=report_item.id) }}"
                     class="btn btn-sm btn-outline-success share-btn me-2">
                    Manage Sharing
                  </a>

                  <!-- View Dashboard stays the same -->
                  <a href="{{ url_for('main.results_dashboard', report_id=report_item.id) }}"
                     class="btn btn-sm btn-info share-btn">
                    View Dashboard
                  </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card tilt-card mb-4"> <!-- Added card class for consistency -->
            <div class="card-body"> <!-- Added card-body -->
                <h2 class="h4 mb-3 text-center">Sentiment Distribution</h2> <!-- Centered heading -->
                <div style="height: 300px;"> <!-- Added fixed height for canvas parent -->
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card tilt-card">
            <div class="card-body">
                <h2 class="h4 mb-3 chart-heading no-animation text-center">Summary</h2> <!-- Centered heading -->
                <div class="row text-center">
                    <div class="col-4">
                        <div class="sentiment-stat">
                            <span class="badge bg-success mb-2">Positive</span>
                            <h3 class="h2">{{ sentiment_counts.positive or 0 }}</h3>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="sentiment-stat">
                            <span class="badge bg-secondary mb-2">Neutral</span>
                            <h3 class="h2">{{ sentiment_counts.neutral or 0 }}</h3>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="sentiment-stat">
                            <span class="badge bg-danger mb-2">Negative</span>
                            <h3 class="h2">{{ sentiment_counts.negative or 0 }}</h3>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <p>Total analyzed items: <strong>{{ (sentiment_counts.positive or 0) + (sentiment_counts.neutral or 0) + (sentiment_counts.negative or 0) }}</strong></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="card tilt-card p-4 text-center">
    <div class="card-body">
        <h2 class="h4">No Results Yet</h2>
        <p>You haven't analyzed any text yet.</p>
        <a href="{{ url_for('main.analyze') }}" class="btn btn-primary mt-2">Analyze Some Now!</a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Define sentiment data as a global variable
  var sentimentData = JSON.parse('{{ sentiment_counts|tojson|safe }}');
  
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('sentimentChart');
    if (ctx && sentimentData && (sentimentData.positive || sentimentData.neutral || sentimentData.negative)) { // Check if there's data
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Positive', 'Neutral', 'Negative'],
          datasets: [{
            label: 'Sentiment Distribution',
            data: [
              sentimentData.positive || 0,
              sentimentData.neutral || 0,
              sentimentData.negative || 0
            ],
            backgroundColor: [
              'rgba(40, 167, 69, 0.7)',
              'rgba(108, 117, 125, 0.7)',
              'rgba(220, 53, 69, 0.7)'
            ],
            borderColor: [
              'rgba(40, 167, 69, 1)',
              'rgba(108, 117, 125, 1)',
              'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          animation: {
            animateScale: true,
            animateRotate: true,
            duration: 1200,
            easing: 'easeOutQuart'
          },
          plugins: {
              legend: {
                position: 'top',
                labels: { font: { size: 14 }, padding: 20 }
              },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    } else if (ctx) {
        ctx.parentNode.innerHTML = '<p class="text-center text-muted mt-3">Not enough data for sentiment distribution chart.</p>';
    }
  });
</script>
{% endblock %}