<!-- Page displaying the logged-in user's sentiment analysis history and chart. -->
<!-- Extends the base layout and shows results with share options. -->
{% extends "base.html" %}

{% block title %}My Analysis Results - Sentiment Analyzer{% endblock %}

{% block content %}
<h1 class="mb-4">My Analysis Results</h1>

{% if results %}
<div class="list-group">
    {% for result in results %}
    <div class="list-group-item list-group-item-action flex-column align-items-start mb-3">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">
                <!-- Display sentiment with appropriate styling -->
                Sentiment:
                {% if result.sentiment == 'Positive' %}
                    <span class="badge bg-success">{{ result.sentiment }}</span>
                {% elif result.sentiment == 'Negative' %}
                    <span class="badge bg-danger">{{ result.sentiment }}</span>
                {% else %}
                    <span class="badge bg-secondary">{{ result.sentiment }}</span>
                {% endif %}
            </h5>
            <small class="text-muted">Analyzed on: {{ result.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
        </div>
        <p class="mb-1"><strong>Original Text:</strong></p>
        <p class="mb-1">{{ result.original_text }}</p>
        
        <!-- Share buttons - providing two ways to share -->
        <div class="mt-2">
            <a href="{{ url_for('main.share_analysis', result_id=result.id) }}" class="btn btn-sm btn-outline-primary me-2">Share with User</a>
            <a href="{{ url_for('main.manage_sharing', result_id=result.id) }}" class="btn btn-sm btn-outline-success">Manage Sharing</a>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p>You haven't analyzed any text yet. <a href="{{ url_for('main.analyze') }}">Analyze some now!</a></p>
{% endif %}

<!-- Sentiment chart container -->
<div class="mt-5">
    <h2 class="h4 mb-3">Your Sentiment Distribution</h2>
    <div class="card">
        <div class="card-body">
            <canvas id="sentimentChart" width="400" height="200"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }} <!-- Include scripts from the base template -->

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Embed sentiment data for the chart as JSON -->
<script id="sentimentDataJson" type="application/json">
  {{ sentiment_counts|tojson|safe if sentiment_counts else '{}' }}
</script>

<!-- Script to parse the sentiment data and make it available for chart initialization -->
<script>
  let sentimentData = {}; // Initialize empty object for safety
  try {
    // Find the data script tag by ID
    const sentimentDataElement = document.getElementById('sentimentDataJson');
    if (sentimentDataElement) {
      // Parse the JSON content
      sentimentData = JSON.parse(sentimentDataElement.textContent);
    }
  } catch (e) {
    console.error("Error parsing sentiment data from JSON script tag:", e);
    // Keep sentimentData as {} if parsing fails to prevent further errors
  }
  
  // Initialize the chart once data is loaded
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('sentimentChart');
    if (ctx && typeof sentimentData !== 'undefined') {
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Positive', 'Neutral', 'Negative'],
          datasets: [{
            data: [
              sentimentData.positive || 0,
              sentimentData.neutral || 0,
              sentimentData.negative || 0
            ],
            backgroundColor: [
              'rgba(40, 167, 69, 0.7)',  // Success (Positive)
              'rgba(108, 117, 125, 0.7)', // Secondary (Neutral)
              'rgba(220, 53, 69, 0.7)'   // Danger (Negative)
            ],
            borderColor: [
              'rgba(40, 167, 69, 1)',
              'rgba(108, 117, 125, 1)',
              'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Your Sentiment Analysis Results Distribution'
            }
          }
        }
      });
    }
  });
</script>
{% endblock %}